[system]
prompt = """
You are a helpful and precise question answering assistant. Your ultimate goal is to generate a comprehensive, accurate, and source-based answer to the user's initial query based on the provided context.
When performing each step of the task, please strictly follow the given instructions and remain consise and efficient.
Remember, Do not add comments or explanations unrelated to the task in your answer.
Think Step by Step.
"""

[tasks]
plan = """
# GOAL: In this stage, your goal is to analyse the user's query and any previous steps to decide the single next action: either decompose the user's query or generate the final answer

# OUTPUT INSTRUCTIONS:
Your output MUST be a single, valid JSON object.
Based on the "Previous Step Analysis", decide if the "User Query" can be fully answered.
**IF information is INSUFFICIENT** (e.g., "Previous Step Analysis" is empty or incomplete), your JSON must be:
  {{
    "action": "sub_question",
    "sub_question": "The specific, fine-grained question to search for.",
    "need_search": "This MUST be a Just the STRING form of 'True' or 'False' to determine whether external knowledge is needed to answer this sub-question"
  }}

IF information is SUFFICIENT, your JSON must be:
{{
  "action": "generate_final_answer",
  "final_answer": "Your final answer to the 'User Query'."
}}

# NOTE:
- Think carefully.
- The sub-question is a query that can be understood by search engine. Do NOT add any references (pronouns) in the sub-question.
- Do NOT simply repeat the user's query.  

---
# EXAMPLES:

**Example 1: First Step, Search Needed**

**User Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Previous Step Analysis:** ""

**Your Output:**
{{
    "action": "sub_question",
    "sub_question": "developer of 'Cyberpunk 2077'",
    "need_search": "True"
}}

---
**Example 2: Subsequent Step, Further Search Needed**

**User Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Previous Step Analysis:** "The developer is CD Projekt Red, but the CEO's name is still missing and needs to be searched for."

**Your Output:**
{{
    "action": "sub_question",
    "sub_question": "current CEO of CD Projekt Red",
    "need_search": "True"
}}

---
**Example 3: Can Answer Now**

**User Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Previous Step Analysis:** "The previous search has confirmed that the developer of 'Cyberpunk 2077' is CD Projekt Red. A subsequent search found that as of late 2024, the joint CEOs of CD Projekt Red are Adam Badowski and Michał Nowakowski."

**Your Output:**
{{
  "reasoning": "The 'Previous Step Analysis' explicitly states the names of the joint CEOs of CD Projekt Red, which is the developer of the game. This information directly and completely answers the user's original query. Therefore, no more searching is needed, and the next action should be to generate the final answer.",
  "action": "generate_final_answer",
  "final_answer": "[The name of joint CEOs]"
}}

---
# TASK TO COMPLETE:

**User Query:** {query}
**Previous Step Analysis:** {further_analysis}

**Your Output:**
"""


assess = """
Is the following document sufficient to answer the query '{query}'?
Document: {docs}
Please answer strictly in the format 'pass' or 'fail: [reason]'.
"""

refine = """
The search results for '{query}' are unsatisfactory because '{reason}'.
Please generate a new, more specific, atomatic and precise query based on the context to address this issue. Only generate the refined query.
"""

generate = """
# GOAL: In this stage, your goal is to generate an answer to "Current Query" based on the provided "Information"(if any).

---
# JSON SCHEMA
You must generate a SINGLE, valid JSON object as your output. MUST conform to the following structure:
{{
  "reasoning": "string",
  "response": "string"
}}

---
# KEY DEFINITIONS
1. `reasoning` (string): Your step-by-step analysis of the "Current Query". Explicitly state your reasoning towards current query.
2. `response` (string): Your response to the "Current Query".
3. **NOTE**: The keys of JSON can only be the above two, and no others can be generated.

---
# EXAMPLES:

**Example 1: Extractive Answering with Information**

**Current Query:** "What is the primary function of a surfboard lock?"
**Information:** "A surfboard lock is a device or a mechanism for securing a surfboard to prevent theft or loss. They typically attach to some part of the surfboard, such as the leash plug or center fin box slot."

**Your Output:**
{{
    "reasoning": "The user is asking for the main purpose of a surfboard lock. The provided information directly states that its function is 'securing a surfboard to prevent theft or loss'. I will extract this phrase as the answer.",
    "response": "A surfboard lock is used for securing a surfboard to prevent theft or loss."
}}

---
**Example 2: Synthesized Answering with Information**

**Current Query:** "Who is the developer of 'Cyberpunk 2077' and where are they based?"
**Information:** "Document 1: The video game 'Cyberpunk 2077' was developed by the team at CD Projekt Red. Document 2: CD Projekt is a leading Polish company in the video game industry, with its headquarters in Warsaw."

**Your Output:**
{{
    "reasoning": "The user wants to know the developer of 'Cyberpunk 2077' and their location. Document 1 identifies the developer as 'CD Projekt Red'. Document 2 states that CD Projekt is a Polish company based in Warsaw. I will combine these two pieces of information to form a complete answer.",
    "response": "Cyberpunk 2077 was developed by CD Projekt Red, which is based in Warsaw, Poland."
}}

---
**Example 3: Generative Answering without Information**

**Current Query:** "What is 2+2?"
**Information:** ""

**Your Output:**
{{
    "reasoning": "The user is asking a basic arithmetic question. I do not need external information to answer this. I will use my internal knowledge to calculate the result. The sum of 2 and 2 is 4.",
    "response": "4"
}}
---

# TASK TO COMPLETE:

**Current Query:** "{current_query}"
**Information:** "{docs}"
**Your Output:**
"""


judge = """
# GOAL: In this stage, you are a judge. Your task is to determine if the "Answer Generated So Far" to the "Current Query" is sufficient to fully answer the user's "Initial Query". Follow the following format strictly.

---
# JSON SCHEMA
You must generate a SINGLE, valid JSON object as your output. MUST conform to one of the following structures:
{{
  "reasoning": "string",
  "final_answer": "string"
}}

or

{{
    "reasoning": "string",
    "further_analysis": "string"
}}

---
# INSTRUCTIONS:
1. Compare the "Initial Query" with the "Answer Generated So Far".
2. `reasoning` (string): Your step-by-step analysis of the task. 
3. `final_answer` (string): If the answer is sufficient, use the "final_answer" key to include the complete final answer. Simplify the final_answer into a concise phrase without losing key information.
4. `further_analysis` (string): If not sufficient, use the "further_analysis" key to explain what is still missing.
5. **NOTE**: The keys of JSON can only be the above three, and no others can be generated.

---
# EXAMPLES:

**Example 1: Multi-Step Continuation**
**Current Query:** Which company developed the game 'Cyberpunk 2077'?
**Initial Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Answer Generated So Far:** "Cyberpunk 2077 was developed by CD Projekt Red."
**Your Output:**
{{
    "reasoning": "The answer so far correctly identifies the developer company. However, the initial query asks for the CEO, which is still unknown. Therefore, the answer is not sufficient.",
    "further_analysis": "The developer is CD Projekt Red, but the CEO's name is still missing and needs to be searched for."
}}

---
**Example 2: Multi-Step Completion**
**Current Query:** Who is the CEO of CD Projekt Red?
**Initial Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Answer Generated So Far:** "The current CEO of CD Projekt Red is Adam Kiciński."
**Your Output:**
{{
    "reasoning": "The answer so far provides the CEO's name. This information fully satisfies the user's initial query. The answer is sufficient.",
    "final_answer": "Adam Kiciński"
}}

---
# TASK TO COMPLETE:

**Initial Query:** "{initial_query}"
**Current Query:** "{current_query}"
**Answer Generated So Far:** "{generated_answer}"
**Your Output:**
"""
