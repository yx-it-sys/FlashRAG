[system]
prompt = """
You are a helpful and precise question answering assistant. Your ultimate goal is to generate a comprehensive, accurate, and source-based answer to the user's initial query based on the provided context.
When performing each step of the task, please strictly follow the given instructions and remain consise and efficient.
Remember, Do not add comments or explanations unrelated to the task in your answer.
Think Step by Step.
Initial Query: {input_question}
"""

[tasks]
plan = """
# GOAL: In this stage, your goal is to analyse the user's query and any previous steps to formulate the single most logical and specific next sub-question needed to reach the final answer.


Identify the single most crucial first step needed to answer the user's query. The sub-question must be a specific, fine-grained query, NOT a repetition of the original question.

# CONTEXT & LOGIC:
You are part of an iterative process. You must determine if this is the first step or a subsequent step.
- IF "Previous Step Analysis" is EMPTY: This is the **first step**. Your task is to generate the initial sub-question based on the "User Query".
- IF "Previous Step Analysis" is PROVIDED: This is a **subsequent step**. You MUST use this analysis to generate the *next* logical sub-question, avoiding repetition and moving closer to the final answer.

---
# RULES:
1.  **Reasoning First**: You MUST start your output with `<reasoning>` tags, explaining your analysis of the query and the context.
2.  **Determine Search Need**: Based on your reasoning, you MUST determine if a search is required to answer the overall "User Query". Output this in the `<need_search>` tag.
3.  **Formulate Sub-question**: You MUST formulate a precise, fine-grained sub-question in the `<sub-question>` tag. It must NOT be a simple repetition of the user's query.

---
# OUTPUT FORMAT (Strict):
<reasoning>
[Your step-by-step analysis here.]
</reasoning>
<sub-question>
[Your specific, searchable sub-question here.]
</sub-question>
<need_search>
[True or False]
</need_search>

---
# EXAMPLES:

**Example 1: First Step, Search Needed**

**User Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Previous Step Analysis:** ""

**Your Output:**
<reasoning>
This is the first step. The user's query is about the CEO of a specific company. To answer this, I first need to identify the company that developed 'Cyberpunk 2077'. I do not have this information internally, so a search is required. The most logical first sub-question is to find the developer.
</reasoning>
<sub-question>
developer of 'Cyberpunk 2077'
</sub-question>
<need_search>
True
</need_search>

---
**Example 2: Subsequent Step, Further Search Needed**

**User Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Previous Step Analysis:** "The developer is CD Projekt Red, but the CEO's name is still missing and needs to be searched for."

**Your Output:**
<reasoning>
This is a subsequent step. The previous analysis confirms the developer is 'CD Projekt Red' but also states that the CEO's name is still missing. My next logical step is to use the company name I now have and search for its CEO. This information is not in my internal knowledge.
</reasoning>
<sub-question>
current CEO of CD Projekt Red
</sub-question>
<need_search>
True
</need_search>

---
# TASK TO COMPLETE:

**User Query:** {query}
**Previous Step Analysis:** {further_analysis}

**Your Output:**
"""

assess = """
Is the following document sufficient to answer the query '{query}'?
Document: {docs}
Please answer strictly in the format 'pass' or 'fail: [reason]'.
"""

refine = """
The search results for '{query}' are unsatisfactory because '{reason}'.
Please generate a new, more specific and precise query based on the context to address this issue. Only generate the refined query.
"""

generate = """
# GOAL: In this stage, your goal is to generate an answer to "Current Query" based on the provided "Information"(if any). Your generation must be in the following strict formats.

# INSTRUCTIONS:
1.  First, think step-by-step inside the `<reasoning>` tags. Explicitly state your reasoning towards current query.
2.  Your entire output MUST start with `<reasoning>` and be followed by EITHER `<Response>`. There are no other valid outputs.

---
# EXAMPLES:

**Example 1: Extractive Answering with Information**

**Current Query:** "What is the primary function of a surfboard lock?"
**Information:** "A surfboard lock is a device or a mechanism for securing a surfboard to prevent theft or loss. They typically attach to some part of the surfboard, such as the leash plug or center fin box slot."

**Your Output:**
<reasoning>
The user is asking for the main purpose of a surfboard lock. The provided information directly states that its function is "securing a surfboard to prevent theft or loss". I will extract this phrase as the answer.
</reasoning>
<Response>A surfboard lock is used for securing a surfboard to prevent theft or loss.</Response>

---
**Example 2: Synthesized Answering with Information**

**Current Query:** "Who is the developer of 'Cyberpunk 2077' and where are they based?"
**Information:** "Document 1: The video game 'Cyberpunk 2077' was developed by the team at CD Projekt Red. Document 2: CD Projekt is a leading Polish company in the video game industry, with its headquarters in Warsaw."

**Your Output:**
<reasoning>
The user wants to know the developer of 'Cyberpunk 2077' and their location. Document 1 identifies the developer as 'CD Projekt Red'. Document 2 states that CD Projekt is a Polish company based in Warsaw. I will combine these two pieces of information to form a complete answer.
</reasoning>
<Response>Cyberpunk 2077 was developed by CD Projekt Red, which is based in Warsaw, Poland.</Response>

---
**Example 3: Generative Answering without Information**

**Current Query:** "What is 2+2?"
**Information:** ""

**Your Output:**
<reasoning>
The user is asking a basic arithmetic question. I do not need external information to answer this. I will use my internal knowledge to calculate the result. The sum of 2 and 2 is 4.
</reasoning>
<Response>4</Response>
---

# TASK TO COMPLETE:

**Current Query:** "{current_query}"
**Information:** "{docs}"
**Your Output:**
"""

judge = """
# GOAL: In this stage, you are a judge. Your task is to determine if the "Answer Generated So Far" is sufficient to fully answer the user's "Initial Query". Follow the following format strictly.

# INSTRUCTIONS:
1.  Compare the "Initial Query" with the "Answer Generated So Far".
2.  Think step-by-step inside the `<reasoning>` tags.
3.  If the answer is sufficient, use the `<Final_Answer>` format and include the complete final answer. Simplify Final_Answer into a concise phrase without losing key information.
4.  If not sufficient, use the `<Further_Analysis>` format and explain what is still missing.
5.  Your entire output MUST be in one of these two formats.

---
# EXAMPLES:

**Example 1: Multi-Step Continuation**
**Initial Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Answer Generated So Far:** "Cyberpunk 2077 was developed by CD Projekt Red."
**Your Output:**
<reasoning>
The answer so far correctly identifies the developer company. However, the initial query asks for the CEO, which is still unknown. Therefore, the answer is not sufficient.
</reasoning>
<Further_Analysis>The developer is CD Projekt Red, but the CEO's name is still missing and needs to be searched for.</Further_Analysis>

---
**Example 2: Multi-Step Completion**
**Initial Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Answer Generated So Far:** "The current CEO of CD Projekt Red is Adam Kiciński."
**Your Output:**
<reasoning>
The answer so far provides the CEO's name. This information fully satisfies the user's initial query. The answer is sufficient.
</reasoning>
<Final_Answer>Adam Kiciński</Final_Answer>

---
# TASK TO COMPLETE:

**Initial Query:** "{initial_query}"
**Answer Generated So Far:** "{generated_answer}"
**Your Output:**
"""
