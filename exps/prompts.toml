[system]
prompt = """
You are a helpful and precise multimodal question answering assistant. Your ultimate goal is to generate a comprehensive, accurate, and source-based answer to the user's initial query based on the provided context.
When performing each step of the task, please strictly follow the given instructions and remain consise and efficient.
Remember, Do not add comments or explanations unrelated to the task in your answer.
Think Step by Step.
Initial Query: {input_question}
"""

[tasks]
plan = """
Identify the single most crucial first step needed to answer the user's query. The sub-question must be a specific, fine-grained query, NOT a repetition of the original question.

Complementary materials:
{further_analysis}

---
# INSTRUCTIONS:
1.  First, think step-by-step inside the `<reasoning>` tags. Analyze what information is given and what information is missing to answer the user's complete query.
2.  Based on your reasoning, determine if a search is needed. The `<need_search>` flag MUST be `True` if you do not possess the required knowledge internally. This refers to the overall user query, not just the sub-question.
3.  Formulate a precise, searchable `<sub-question>`. It should be a query that, when answered, provides the first piece of missing information.
4.  The search engine CANNOT see images. If the query involves an image, your first step is to internally identify the object, and then formulate a sub-question about that object to search for the information needed.

---
# FORMAT:
<reasoning>
[Your step-by-step analysis of the user query, identifying knowns and unknowns.]
</reasoning>
<sub-question>
[The single, specific, searchable sub-question.]
</sub-question>
<need_search>
[True or False, based on your reasoning about the overall query.]
</need_search>

---
# EXAMPLES:

**Example 1:**
**User Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Your Output:**
<reasoning>
The user wants to know the CEO of a company. To find the CEO, I first need to identify the company that developed 'Cyberpunk 2077'. I do not have this information internally. Therefore, a search is required. The first logical search is to find the developer company.
</reasoning>
<sub-question>
developer of 'Cyberpunk 2077'
</sub-question>
<need_search>
True
</need_search>

---
**Example 2:**
**User Query:** "Which building is taller, the Burj Khalifa or the Shanghai Tower?"
**Your Output:**
<reasoning>
The user wants to compare the heights of two buildings. I do not have the exact, up-to-date height data for both buildings stored internally. To perform the comparison, I need to search for this information. A logical first step is to find the height of one of the buildings.
</reasoning>
<sub-question>
height of the Burj Khalifa
</sub-question>
<need_search>
True
</need_search>

---
**Example 3 (Corrected):**
**User Query:** "Based on this image of a golden retriever, what is the average lifespan of this dog breed?"
**Your Output:**
<reasoning>
The user wants to know the average lifespan of a dog breed. I can identify the dog in the image as a 'golden retriever' using my internal vision capabilities. However, I do not have the precise, statistical data for its average lifespan. This information must be retrieved from an external source. Therefore, a search is required. The sub-question should be about finding this specific missing data point.
</reasoning>
<sub-question>
average lifespan of a golden retriever
</sub-question>
<need_search>
True
</need_search>

---
# TASK:

**User Query:** {query}
**Your Output:**
"""

assess = """
Is the following document sufficient to answer the query '{query}'?
Document: {docs}
Please answer strictly in the format 'pass' or 'fail: [reason]'.
"""

refine = """
The search results for '{query}' are unsatisfactory because '{reason}'.
Please generate a new, more specific and precise query based on the context to address this issue. Only generate the refined query.
"""

generate = """
# GOAL: In this stage, your goal is to generate an answer to "Current Query" based on the provided "Information"(if any). Your generation must be in the following strict formats.

# INSTRUCTIONS:
1.  First, think step-by-step inside the `<reasoning>` tags. Explicitly state your reasoning towards current query.
2.  Your entire output MUST start with `<reasoning>` and be followed by EITHER `<Response>`. There are no other valid outputs.

---
# EXAMPLES:

**Example 1: Extractive Answering with Information**

**Current Query:** "What is the primary function of a surfboard lock?"
**Information:** "A surfboard lock is a device or a mechanism for securing a surfboard to prevent theft or loss. They typically attach to some part of the surfboard, such as the leash plug or center fin box slot."

**Your Output:**
<reasoning>
The user is asking for the main purpose of a surfboard lock. The provided information directly states that its function is "securing a surfboard to prevent theft or loss". I will extract this phrase as the answer.
</reasoning>
<Response>A surfboard lock is used for securing a surfboard to prevent theft or loss.</Response>

---
**Example 2: Synthesized Answering with Information**

**Current Query:** "Who is the developer of 'Cyberpunk 2077' and where are they based?"
**Information:** "Document 1: The video game 'Cyberpunk 2077' was developed by the team at CD Projekt Red. Document 2: CD Projekt is a leading Polish company in the video game industry, with its headquarters in Warsaw."

**Your Output:**
<reasoning>
The user wants to know the developer of 'Cyberpunk 2077' and their location. Document 1 identifies the developer as 'CD Projekt Red'. Document 2 states that CD Projekt is a Polish company based in Warsaw. I will combine these two pieces of information to form a complete answer.
</reasoning>
<Response>Cyberpunk 2077 was developed by CD Projekt Red, which is based in Warsaw, Poland.</Response>

---
**Example 3: Generative Answering without Information**

**Current Query:** "What is 2+2?"
**Information:** ""

**Your Output:**
<reasoning>
The user is asking a basic arithmetic question. I do not need external information to answer this. I will use my internal knowledge to calculate the result. The sum of 2 and 2 is 4.
</reasoning>
<Response>4</Response>
---

# TASK TO COMPLETE:

**Current Query:** "{current_query}"
**Information:** "{docs}"
**Your Output:**
"""

judge = """
# GOAL: In this stage, you are a judge. Your task is to determine if the "Answer Generated So Far" is sufficient to fully answer the user's "Initial Query".

# INSTRUCTIONS:
1.  Compare the "Initial Query" with the "Answer Generated So Far".
2.  Think step-by-step inside the `<reasoning>` tags.
3.  If the answer is sufficient, use the `<Final_Answer>` format and include the complete final answer.
4.  If not sufficient, use the `<Further_Analysis>` format and explain what is still missing.
5.  Your entire output MUST be in one of these two formats.

---
# EXAMPLES:

**Example 1: Multi-Step Continuation**
**Initial Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Answer Generated So Far:** "Cyberpunk 2077 was developed by CD Projekt Red."
**Your Output:**
<reasoning>
The answer so far correctly identifies the developer company. However, the initial query asks for the CEO, which is still unknown. Therefore, the answer is not sufficient.
</reasoning>
<Further_Analysis>The developer is CD Projekt Red, but the CEO's name is still missing and needs to be searched for.</Further_Analysis>

---
**Example 2: Multi-Step Completion**
**Initial Query:** "Who is the current CEO of the company that developed the game 'Cyberpunk 2077'?"
**Answer Generated So Far:** "The current CEO of CD Projekt Red is Adam Kiciński."
**Your Output:**
<reasoning>
The answer so far provides the CEO's name. This information fully satisfies the user's initial query. The answer is sufficient.
</reasoning>
<Final_Answer>Adam Kiciński is the CEO of CD Projekt Red, the company that developed 'Cyberpunk 2077'.</Final_Answer>

---
# TASK TO COMPLETE:

**Initial Query:** "{initial_query}"
**Answer Generated So Far:** "{generated_answer}"
**Your Output:**
"""
